Excellente question ğŸ‘

ğŸ‘‰ ClickHouse met Ã  disposition plusieurs tables systÃ¨me pour surveiller en temps rÃ©el les requÃªtes en cours, terminÃ©es ou en erreur.
Voici ce que tu dois connaÃ®tre ğŸ‘‡


---

ğŸ§© 1. Voir les requÃªtes en cours dâ€™exÃ©cution

SELECT
    query_id,
    user,
    query,
    elapsed,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    memory_usage,
    query_kind
FROM system.processes
ORDER BY elapsed DESC;

ğŸ§  Explications :

system.processes = liste des requÃªtes actuellement en cours dâ€™exÃ©cution

elapsed = temps Ã©coulÃ© (secondes)

memory_usage = mÃ©moire consommÃ©e par la requÃªte

query_kind = type (Select, Insert, etc.)



---

ğŸ§© 2. Tuer une requÃªte en cours (si bloquÃ©e)

Identifie le query_id via la requÃªte ci-dessus, puis :

KILL QUERY WHERE query_id = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx' SYNC;

ou pour toutes les requÃªtes dâ€™un utilisateur :

KILL QUERY WHERE user = 'mon_user' SYNC;


---

ğŸ§© 3. Voir les derniÃ¨res requÃªtes exÃ©cutÃ©es (y compris terminÃ©es)

SELECT
    event_time,
    query_id,
    user,
    query,
    type,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    exception_code,
    exception
FROM system.query_log
ORDER BY event_time DESC
LIMIT 50;

ğŸ’¡ type peut Ãªtre :

'QueryStart' â€“ dÃ©but dâ€™exÃ©cution

'QueryFinish' â€“ terminÃ©e avec succÃ¨s

'ExceptionBeforeStart' ou 'ExceptionWhileProcessing' â€“ erreur



---

ğŸ§© 4. Voir la charge du serveur (utile pour SERVER_OVERLOADED)

SELECT * FROM system.metrics
WHERE metric LIKE 'OSCPU%' OR metric LIKE 'Query%' OR metric LIKE 'Memory%';

Tu peux aussi voir :

SELECT * FROM system.asynchronous_metrics
WHERE metric LIKE '%CPU%' OR metric LIKE '%Memory%';


---

ğŸ§© 5. Suivre lâ€™activitÃ© rÃ©seau

SELECT * FROM system.events
WHERE event LIKE '%Network%';

ou les insertions :

SELECT * FROM system.events
WHERE event LIKE '%Insert%';


---

ğŸ§© 6. Pour surveiller en continu (mode "top")

watch -n1 "clickhouse-client --query='SELECT user, elapsed, query FROM system.processes FORMAT Pretty'"

> Cela rafraÃ®chit chaque seconde la liste des requÃªtes actives (comme un htop pour ClickHouse).




---

ğŸš€ Bonus : pour les requÃªtes Spark/Java

Quand tu exÃ©cutes via Spark, tu verras souvent :

user = default (ou ton spark.sql.catalog.clickhouse.user)

query = INSERT INTO ... VALUES (par batch)


Donc tu peux filtrer spÃ©cifiquement les requÃªtes Spark :

SELECT query_id, query, elapsed, memory_usage
FROM system.processes
WHERE query LIKE '%INSERT%' OR query LIKE '%spark%'
ORDER BY elapsed DESC;


---

Souhaites-tu que je te donne une requÃªte â€œdashboardâ€ unique qui combine CPU, requÃªtes actives, mÃ©triques mÃ©moire, et top queries dans un seul rÃ©sultat ?
(Pratique pour surveiller ton cluster ClickHouse sur AKS.)
